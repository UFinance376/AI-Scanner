<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madumara Forex Trading</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Source+Serif+4:wght@700&display=swap');

        :root {
            --bg-color: #0F0F0F;
            --primary-color: #D4AF37; /* Gold */
            --text-color: #E0E0E0;
            --text-secondary: #888;
            --card-bg: #1A1A1A;
            --border-color: #2a2a2a;
            --success-color: #26a69a;
            --danger-color: #ef5350;
            --hover-bg: #222;
            --user-message-bg: #2c2c2e;
            --bot-message-bg: #1e1e20;
            --input-bg: #1e1e20;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .page {
            display: none;
            height: 100vh;
            width: 100vw;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .page.active {
            display: flex;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid transparent;
            font-size: 1rem;
        }
        
        /* --- Login Page --- */
        #login-page {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?auto=format&fit=crop&w=1920');
            background-size: cover;
            background-position: center;
        }

        .login-card {
            background-color: var(--card-bg);
            padding: 3rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
            max-width: 480px;
            width: 90%;
        }

        .login-card h1 {
            font-family: 'Source Serif 4', serif;
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .login-card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .login-form input {
            width: 100%;
            padding: 1rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            text-align: center;
        }

        .login-form input::placeholder {
            color: var(--text-secondary);
        }

        .btn-login {
            background-color: var(--primary-color);
            color: var(--bg-color);
            width: 100%;
            font-size: 1.1rem;
        }
        .btn-login:hover {
            background-color: #e4c35e;
        }
        .btn-login:disabled {
            background-color: #555;
            cursor: not-allowed;
            color: #999;
        }

        /* --- Main Page Layout --- */
        #main-page {
            flex-direction: row;
            align-items: stretch;
            justify-content: flex-start;
        }
        
        /* --- Dashboard Panel --- */
        .dashboard-panel {
            width: 450px;
            flex-shrink: 0;
            background-color: var(--bot-message-bg);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .dashboard-panel h2 {
            font-family: 'Source Serif 4', serif;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 0rem;
        }
        
        .account-details {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-item span:first-child {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detail-item span:last-child {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-color);
        }
        
        #account-balance {
            color: var(--success-color);
            font-size: 1.3rem;
        }

        /* --- Bot Controls --- */
        .bot-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-group.full-width {
            grid-column: 1 / -1;
        }

        .control-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .control-group select, .control-group input {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .bot-actions {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .bot-actions .btn {
            flex-grow: 1;
        }
        
        #start-bot-btn {
            background-color: var(--success-color);
            color: white;
        }

        #stop-bot-btn {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* --- Bot Log --- */
        #bot-log-container {
            flex-grow: 1;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            min-height: 150px;
        }

        #bot-log {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        #bot-log p {
            margin-bottom: 0.5rem;
            white-space: pre-wrap;
        }

        #bot-log p.buy { color: var(--success-color); font-weight: bold; }
        #bot-log p.sell { color: var(--danger-color); font-weight: bold; }
        #bot-log p.info { color: var(--text-secondary); }
        #bot-log p.error { color: var(--primary-color); font-weight: bold; }
        #bot-log p.pass { color: #81C784; } /* Lighter green */


        .dashboard-footer {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding-top: 1rem;
            margin-top: auto;
            border-top: 1px solid var(--border-color);
        }


        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1612178537253-bccd437b73a2?auto=format&fit=crop&w=1920');
            background-size: cover;
            background-position: center;
        }
        
        .main-content-overlay {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
            background-color: rgba(15, 15, 15, 0.8); /* Dark overlay for text readability */
        }
        
        /* --- Chat Container --- */
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 1.5rem;
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 1rem; /* for scrollbar */
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 75%;
            padding: 0.75rem 1.25rem;
            border-radius: 18px;
            line-height: 1.5;
            white-space: pre-wrap; /* Respect newlines in messages */
        }

        .message.user {
            background-color: var(--user-message-bg);
            border-bottom-right-radius: 3px;
            align-self: flex-end;
        }

        .message.bot {
            background-color: var(--bot-message-bg);
            border-bottom-left-radius: 3px;
            align-self: flex-start;
        }
        
        .message.bot.typing {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .chat-input-form {
            padding: 1.5rem 0 0 0;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .chat-input-wrapper {
            position: relative;
            display: flex;
            align-items: flex-end; /* Align button to bottom */
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 0.5rem; /* Padding for the wrapper */
            transition: border-color 0.3s ease;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
        }

        #chat-input {
            flex-grow: 1;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            resize: none;
            line-height: 1.5;
            max-height: 150px; /* Limit max height */
            overflow-y: auto;
            padding: 0.35rem 0.5rem; /* Vertical padding for textarea */
        }
        
        #chat-input::placeholder {
            color: var(--text-secondary);
        }

        .chat-input-form button {
            background-color: var(--primary-color);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.3s ease;
            margin-left: 0.5rem;
        }
        
        .chat-input-form button:disabled {
            background-color: var(--card-bg);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .chat-input-form button:not(:disabled):hover {
            background-color: #e4c35e; /* Lighter gold */
        }

        .chat-input-form button svg {
            width: 20px;
            height: 20px;
            transition: fill 0.3s ease;
        }
        
        .chat-input-form button:not(:disabled) svg {
            fill: var(--bg-color);
        }
        
        .chat-input-form button:disabled svg {
            fill: var(--text-secondary);
        }

    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <div id="login-page" class="page active">
        <div class="login-card">
            <h1>Madumara</h1>
            <p>Forex Trading Academy</p>
            <div class="login-form">
                <input type="password" id="api-token-input" placeholder="Enter Your Deriv API Token">
                <button id="login-button" class="btn btn-login">Access Client Portal</button>
            </div>
        </div>
    </div>

    <main id="main-page" class="page">
        <aside class="dashboard-panel">
            <h2>Trading Dashboard</h2>
            
            <div class="account-details">
                <div class="detail-item">
                    <span>Account Balance</span>
                    <span id="account-balance">--.--</span>
                </div>
                 <div class="detail-item">
                    <span>Login ID</span>
                    <span id="account-loginid">-----------</span>
                </div>
            </div>
            
            <div class="bot-controls">
                <div class="control-group full-width">
                    <label for="symbol-select">Trading Instrument</label>
                    <select id="symbol-select">
                        <option value="V75">Volatility 75 Index</option>
                        <option value="V10">Volatility 10 Index</option>
                        <option value="V100">Volatility 100 Index</option>
                        <option value="XAUUSD">Gold (XAU/USD)</option>
                        <option value="EURUSD">EUR/USD</option>
                        <option value="USDJPY">USD/JPY</option>
                        <option value="Jump75">Jump 75 Index</option>
                        <option value="StepIndex">Step Index</option>
                    </select>
                </div>
                <div class="settings-grid">
                    <div class="control-group">
                        <label for="timeframe-select">Timeframe</label>
                        <select id="timeframe-select">
                            <option value="M1">1 Minute</option>
                            <option value="M5">5 Minutes</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="risk-input">Risk (%)</label>
                        <input type="number" id="risk-input" value="2" min="0.1" max="10" step="0.1">
                    </div>
                    <div class="control-group">
                        <label for="atr-period-input">ATR Period</label>
                        <input type="number" id="atr-period-input" value="14" min="1" max="100">
                    </div>
                    <div class="control-group">
                        <label for="atr-threshold-input">ATR Threshold</label>
                        <input type="number" id="atr-threshold-input" value="0.0005" min="0" step="0.0001">
                    </div>
                    <div class="control-group full-width">
                        <label for="pullback-input">Pullback Sensitivity (Pips)</label>
                        <input type="number" id="pullback-input" value="10" min="1" max="100">
                    </div>
                </div>
                 <div class="bot-actions">
                     <button id="start-bot-btn" class="btn">Start Bot</button>
                     <button id="stop-bot-btn" class="btn" disabled>Stop Bot</button>
                </div>
            </div>

            <div id="bot-log-container" class="bot-log-container">
                <div id="bot-log"></div>
            </div>

            <div class="dashboard-footer">
                <p>Powered by Madumara Forex Trading Academy</p>
            </div>
        </aside>
        
        <section class="main-content">
           <div class="main-content-overlay">
                <div class="chat-container">
                    <div id="chat-messages" class="chat-messages">
                        <!-- Chat messages will be appended here -->
                    </div>
                    <form id="chat-form" class="chat-input-form">
                        <div class="chat-input-wrapper">
                            <textarea id="chat-input" placeholder="Ask about the trading strategy..." rows="1"></textarea>
                            <button type="submit" aria-label="Send message">
                                 <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                            </button>
                        </div>
                    </form>
                </div>
           </div>
        </section>
    </main>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        document.addEventListener('DOMContentLoaded', () => {
            // --- App Pages ---
            const loginPage = document.getElementById('login-page');
            const mainPage = document.getElementById('main-page');

            // --- Auth Elements ---
            const loginButton = document.getElementById('login-button');
            const apiTokenInput = document.getElementById('api-token-input');
            
            // --- Dashboard Elements ---
            const accountBalanceEl = document.getElementById('account-balance');
            const accountLoginIdEl = document.getElementById('account-loginid');

            // --- Chat Elements ---
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');
            const sendButton = chatForm.querySelector('button');
            
            // --- Bot Elements ---
            const startBotBtn = document.getElementById('start-bot-btn');
            const stopBotBtn = document.getElementById('stop-bot-btn');
            const symbolSelect = document.getElementById('symbol-select');
            const riskInput = document.getElementById('risk-input');
            const timeframeSelect = document.getElementById('timeframe-select');
            const atrPeriodInput = document.getElementById('atr-period-input');
            const atrThresholdInput = document.getElementById('atr-threshold-input');
            const pullbackInput = document.getElementById('pullback-input');
            const botLog = document.getElementById('bot-log');


            // --- Application State ---
            let ai;
            let chat;
            let isBotRunning = false;
            let botInterval;
            
            // --- Authentication ---
            const handleAuthentication = () => {
                const token = sessionStorage.getItem('deriv_token');
                if (token) {
                    authorizeWithToken(token);
                } else {
                    showLoginPage();
                }
            };

            const handleLogin = () => {
                const token = apiTokenInput.value.trim();
                if (!token) {
                    alert('Please enter a Deriv API Token.');
                    return;
                }
                authorizeWithToken(token);
            };
            
            const authorizeWithToken = (token) => {
                loginButton.disabled = true;
                loginButton.textContent = 'Verifying...';

                const ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');

                ws.onopen = () => {
                    ws.send(JSON.stringify({ authorize: token }));
                };

                ws.onmessage = (msg) => {
                    const response = JSON.parse(msg.data);
                    if (response.error) {
                        alert(`Authentication Failed: ${response.error.message}`);
                        sessionStorage.removeItem('deriv_token');
                        showLoginPage();
                    } else if (response.authorize) {
                        sessionStorage.setItem('deriv_token', token);
                        updateAccountDisplay(response.authorize);
                        showMainPage();
                    }
                    ws.close();
                };

                ws.onerror = (err) => {
                    console.error('WebSocket Error:', err);
                    alert('Could not connect to Deriv API. Please check your internet connection and try again.');
                    showLoginPage();
                    ws.close();
                };
                
                setTimeout(() => {
                    if (ws.readyState !== WebSocket.CLOSED) {
                        ws.close();
                        alert('Authentication timed out. Please try again.');
                        showLoginPage();
                    }
                }, 10000);
            }

            const showLoginPage = () => {
                loginPage.classList.add('active');
                mainPage.classList.remove('active');
                loginButton.disabled = false;
                loginButton.textContent = 'Access Client Portal';
            };

            const showMainPage = () => {
                loginPage.classList.remove('active');
                mainPage.classList.add('active');
                initializeChat();
                logToBot('Bot ready. Configure settings and press Start.', 'info');
            };
            
            const updateAccountDisplay = (authData) => {
                if (accountBalanceEl && accountLoginIdEl) {
                    const balance = authData.balance;
                    const currency = authData.currency;
                    accountBalanceEl.textContent = `${balance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${currency}`;
                    accountLoginIdEl.textContent = authData.loginid;
                }
            }
            
            // --- Trading Bot ---
            const startBot = () => {
                if (isBotRunning) return;
                isBotRunning = true;
                
                const controls = [symbolSelect, riskInput, timeframeSelect, atrPeriodInput, atrThresholdInput, pullbackInput, startBotBtn];
                controls.forEach(el => el.disabled = true);
                stopBotBtn.disabled = false;
                
                const symbol = symbolSelect.value;
                const timeframe = timeframeSelect.value;
                const risk = riskInput.value;
                
                logToBot(`--- Bot Started ---`, 'info');
                logToBot(`Strategy: Madumara Forex Academy`, 'info');
                logToBot(`Instrument: ${symbol} | Timeframe: ${timeframe} | Risk: ${risk}%`, 'info');
                
                botInterval = setInterval(runBotCycle, 5000);
            };

            const stopBot = () => {
                if (!isBotRunning) return;
                isBotRunning = false;
                
                clearInterval(botInterval);
                
                const controls = [symbolSelect, riskInput, timeframeSelect, atrPeriodInput, atrThresholdInput, pullbackInput, startBotBtn];
                controls.forEach(el => el.disabled = false);
                stopBotBtn.disabled = true;
                
                logToBot(`--- Bot Stopped ---`, 'info');
            };
            
            const runBotCycle = () => {
                // --- Get settings ---
                const symbol = symbolSelect.value;
                const timeframe = timeframeSelect.value;
                const risk = riskInput.value;
                const atrThreshold = parseFloat(atrThresholdInput.value);
                const pullbackPips = parseInt(pullbackInput.value);

                // --- Simulate market data ---
                const atr = Math.random() * 0.0015;
                const rsi = Math.floor(Math.random() * 100);

                logToBot(`[${symbol} | ${timeframe}] New analysis cycle...`, 'info');
                
                // 1. Market Filter (Choppy Market)
                logToBot(`[${symbol}] ATR Check: Value is ${atr.toFixed(5)}. Threshold > ${atrThreshold}`, 'info');
                if (atr < atrThreshold) {
                    logToBot(`[${symbol}] FILTER: Market is choppy, ATR below threshold. No trade.`, 'info');
                    return;
                }
                logToBot(`[${symbol}] PASS: Market has enough volatility.`, 'pass');

                // 2. Trend Direction Filter
                const trendState = Math.random(); 
                
                if (trendState > 0.5) { // SIMULATE UPTREND
                    logToBot(`[${symbol}] Trend Check: UPTREND (Price > 20/200 EMA). Searching for BUY signals.`, 'info');
                    
                    // 3. RSI Condition
                    logToBot(`[${symbol}] RSI Check: Value is ${rsi}. Required: > 50 and < 70.`, 'info');
                    if (rsi > 70) {
                        logToBot(`[${symbol}] FILTER: RSI is overbought (${rsi}). Waiting for pullback.`, 'info');
                        return;
                    }
                    if (rsi <= 50) {
                        logToBot(`[${symbol}] FILTER: RSI (${rsi}) shows no bullish momentum. No trade.`, 'info');
                        return;
                    }
                    logToBot(`[${symbol}] PASS: RSI indicates bullish momentum.`, 'pass');
                    
                    // 4. Entry Simulation (Fractal Breakout / Re-entry)
                    const entryType = Math.random() > 0.5 ? 'breakout' : 're-entry';
                    
                    if(entryType === 'breakout') {
                        logToBot(`[${symbol}] Monitoring for recent UP fractal breakout...`, 'info');
                        if(Math.random() > 0.4) {
                             logToBot(`[${symbol}] ENTRY: Fractal breakout confirmed!`, 'buy');
                             logToBot(`[${symbol}] > EXECUTING BUY @ market price.`, 'buy');
                             logToBot(`[${symbol}] > Lot size calculated for ${risk}% risk.`, 'buy');
                             logToBot(`[${symbol}] > SL placed at 2nd last down fractal. Trailing SL activated.`, 'buy');
                        } else {
                             logToBot(`[${symbol}] No breakout yet. Continuing to monitor.`, 'info');
                        }
                    } else { // Re-entry
                        logToBot(`[${symbol}] Monitoring for pullback near 20 EMA (within ${pullbackPips} pips)...`, 'info');
                        if(Math.random() > 0.4) {
                            logToBot(`[${symbol}] RE-ENTRY: Price crossed back above 20 EMA after pullback.`, 'buy');
                            logToBot(`[${symbol}] > EXECUTING BUY @ market price.`, 'buy');
                            logToBot(`[${symbol}] > Lot size calculated for ${risk}% risk.`, 'buy');
                            logToBot(`[${symbol}] > SL placed at 2nd last down fractal. Trailing SL activated.`, 'buy');
                        } else {
                            logToBot(`[${symbol}] No confirmed re-entry signal. Continuing to monitor.`, 'info');
                        }
                    }

                } else { // SIMULATE DOWNTREND
                    logToBot(`[${symbol}] Trend Check: DOWNTREND (Price < 20/200 EMA). Searching for SELL signals.`, 'info');
                    
                    // 3. RSI Condition
                    logToBot(`[${symbol}] RSI Check: Value is ${rsi}. Required: < 50 and > 30.`, 'info');
                    if (rsi < 30) {
                        logToBot(`[${symbol}] FILTER: RSI is oversold (${rsi}). Waiting for pullback.`, 'info');
                        return;
                    }
                    if (rsi >= 50) {
                        logToBot(`[${symbol}] FILTER: RSI (${rsi}) shows no bearish momentum. No trade.`, 'info');
                        return;
                    }
                    logToBot(`[${symbol}] PASS: RSI indicates bearish momentum.`, 'pass');
                    
                    // 4. Entry Simulation (Fractal Breakout / Re-entry)
                    const entryType = Math.random() > 0.5 ? 'breakout' : 're-entry';

                    if(entryType === 'breakout') {
                        logToBot(`[${symbol}] Monitoring for recent DOWN fractal breakout...`, 'info');
                        if(Math.random() > 0.4) {
                             logToBot(`[${symbol}] ENTRY: Fractal breakout confirmed!`, 'sell');
                             logToBot(`[${symbol}] > EXECUTING SELL @ market price.`, 'sell');
                             logToBot(`[${symbol}] > Lot size calculated for ${risk}% risk.`, 'sell');
                             logToBot(`[${symbol}] > SL placed at 2nd last up fractal. Trailing SL activated.`, 'sell');
                        } else {
                             logToBot(`[${symbol}] No breakout yet. Continuing to monitor.`, 'info');
                        }
                    } else { // Re-entry
                        logToBot(`[${symbol}] Monitoring for pullback near 20 EMA (within ${pullbackPips} pips)...`, 'info');
                        if(Math.random() > 0.4) {
                            logToBot(`[${symbol}] RE-ENTRY: Price crossed back below 20 EMA after pullback.`, 'sell');
                            logToBot(`[${symbol}] > EXECUTING SELL @ market price.`, 'sell');
                            logToBot(`[${symbol}] > Lot size calculated for ${risk}% risk.`, 'sell');
                            logToBot(`[${symbol}] > SL placed at 2nd last up fractal. Trailing SL activated.`, 'sell');
                        } else {
                            logToBot(`[${symbol}] No confirmed re-entry signal. Continuing to monitor.`, 'info');
                        }
                    }
                }
            };
            
            const logToBot = (message, type) => {
                if (!botLog) return;
                const p = document.createElement('p');
                p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                p.className = type; // 'buy', 'sell', 'info', 'error', 'pass'
                botLog.prepend(p);
            };


            // --- Gemini Chat ---
            const initializeChat = () => {
                if (!process.env.API_KEY) {
                    displayMessage("API_KEY is not configured.", 'bot');
                    return;
                }
                ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                
                chat = ai.chats.create({
                    model: 'gemini-2.5-flash',
                    config: {
                        systemInstruction: "You are an expert AI assistant for the Madumara Forex Trading Academy. Your purpose is to explain the academy's official trading strategy and clarify how the auto-trading bot operates. You should be able to answer questions about EMA alignment, fractal breakouts, RSI conditions, stop loss placement, and risk management. Do not provide financial advice. Be helpful, precise, and professional.",
                    }
                });

                displayMessage("Welcome to the Madumara Academy Client Portal! I am your AI assistant. Ask me anything about the trading strategy or how the bot works.", 'bot');
            };
            
            const resetChatInputHeight = () => {
                chatInput.style.height = 'auto';
            };

            const handleChatMessage = async (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;

                displayMessage(userMessage, 'user');
                chatInput.value = '';
                sendButton.disabled = true;
                resetChatInputHeight();

                const typingIndicator = displayMessage('Typing...', 'bot', true);

                try {
                    const response = await chat.sendMessage({ message: userMessage });
                    chatMessages.removeChild(typingIndicator);
                    if (response.text) {
                        displayMessage(response.text, 'bot');
                    }

                } catch (error) {
                    console.error('Gemini API Error:', error);
                    chatMessages.removeChild(typingIndicator);
                    displayMessage('Sorry, something went wrong. Please try again.', 'bot');
                } finally {
                    sendButton.disabled = false;
                }
            };
            
            const displayMessage = (text, sender, isTyping = false) => {
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', sender);
                if (isTyping) {
                    messageEl.classList.add('typing');
                }
                messageEl.textContent = text;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
                return messageEl;
            };
            
            // --- Event Listeners & Initialization ---
            loginButton?.addEventListener('click', handleLogin);
            startBotBtn?.addEventListener('click', startBot);
            stopBotBtn?.addEventListener('click', stopBot);


            if (chatForm) {
                sendButton.disabled = true;
                chatInput.addEventListener('input', () => {
                    sendButton.disabled = chatInput.value.trim().length === 0;
                    chatInput.style.height = 'auto';
                    chatInput.style.height = `${chatInput.scrollHeight}px`;
                });
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        chatForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                    }
                });
                chatForm.addEventListener('submit', handleChatMessage);
            }
            
            // --- App Entry Point ---
            handleAuthentication();
        });
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
